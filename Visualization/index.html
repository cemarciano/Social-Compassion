<!DOCTYPE html>
<html>
<script src="js/echarts.min.js"></script>
<script src="js/jquery-3.3.1.min.js"></script>
<script src="js/echarts-wordcloud.min.js"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>

<head>
    <title>News wordclouds - TÃ³p. Esp. Banco de Dados I</title>
    <meta charset="UTF-8">
</head>

<body>
    <script type="text/javascript">
        var countryMasks = {
            "syria": "machine_gun.png"
        };

		var shapesParams = {
			"machine_gun": {
				"width": "1500px",
				"height": "1200px"
			},
			"heart": {
				"width": "1100px",
				"height": "900px"
			},
			"syria_map": {
				"width": "1200px",
				"height": "1000px"
			},
			"bombing": {
				"width": "1900px",
				"height": "1000px"
			}
		}


        function getCountrySeries(wordcloud) {

            var ret = {
                name: wordcloud._dom.id,
                type: 'wordCloud',
                shape: 'circle',
                left: 'center',
                top: 'center',
                sizeRange: [11, 130],
                rotationRange: [0, 90],
                rotationStep: 90,
                gridSize: 4,
                textStyle: {
                    normal: {
                        fontFamily: 'sans-serif',
                        fontWeight: 'bold',
                        // Set word colors according to country, or random if not specified
                        color: function () {
                            // Random color
                            return 'hsl(0,100%,' + Math.round(Math.random() * 40 + 40) + "%)";
                        }
                    },
                    emphasis: {
                        shadowBlur: 10,
                        shadowColor: '#ddd'
                    }
                }
            };
            return ret;
        }

        function loadData(shape) {
            // Get table element
            var table = document.getElementById("table");

            // Remove all child nodes in table
            while (table.firstChild) {
                table.removeChild(table.firstChild);
            };

            var wordclouds = []

            // Asynchronous data loading
            jQuery.get({ url: 'entities.json', cache: false }).done(function (data) {
                //data = JSON.parse(data);


                data.forEach(function (country) {

                    // Create div element for country word cloud
                    var countryDiv = document.createElement("div");
                    countryDiv.id = country.country;
                    countryDiv.style = "width: " + shapesParams[shape].width + "; height: " + shapesParams[shape].height + ";";
                    countryDiv.align = "center";

                    // Get table row element (existent or create new)
                    var row = undefined;
                    if (wordclouds.length % 2 == 0) {
                        row = document.createElement("tr");
                        row.id = "row_" + Math.floor(wordclouds.length / 2);
                        table.appendChild(row);
                    }
                    else {
                        row = document.getElementById("row_" + Math.floor(wordclouds.length / 2));
                    }

                    // Create cell for new word cloud
                    var cell = document.createElement("td");
                    cell.style = "width:1000px;height:1000px;";
                    cell.align = "center";
                    row.appendChild(cell);
                    cell.appendChild(countryDiv);

                    // Add data to div so we can retrieve it afterwards
                    countryDiv.data = country.frequencies;

                    // Initialize ECharts wordcloud
                    var wordcloud = echarts.init(countryDiv);
                    //wordcloud.showLoading();

                    // Set wordcloud click callback
                    wordcloud.on('click', function (params) {
                        console.log(params.data.name, params.data.value, params.dataIndex);
						loadData("bombing")
                    });

                    // Add wordcloud to list
                    wordclouds.push(wordcloud);

                    // Create image for country word cloud mask
                    var maskImage = new Image();
                    maskImage.src = 'img/' + shape + ".png";

                    // LOad mask image
                    maskImage.onload = function () {
                        // Get country series for ECharts wordcloud option
                        var countrySeries = getCountrySeries(wordcloud);

                        countrySeries.maskImage = maskImage;
						countrySeries.data = country.frequencies;

                        var option = {
                            title: {
                                // Convert first letters to upper case in title
                                text: wordcloud._dom.id.replace(/\w\S*/g, function (txt) {
                                    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                                }),
                                //subtext: 'Default layout',
                                top: 'top',
                                left: 'center',
                                textStyle: {
                                    // Set title color according to country, or default if not defined
                                    color: '#fff'
                                }
                            },
                            tooltip: {
                                triggerOn: 'click'
                            },
                            series: countrySeries
                        };

                        //wordcloud.hideLoading();

                        wordcloud.setOption(option);
                    }
                });
            });
        }

        document.body.style = "background-color: #222222";

        // Create table element
        var table = document.createElement("table");
        table.id = "table";
        document.body.appendChild(table);

        // LOad data for the first time
        loadData("machine_gun");
    </script>
</body>

</html>
